{{define "post.html"}}
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{.Title}} - stegodon</title>

        <!-- SEO Meta Tags -->
        <meta name="description" content="Post by @{{.User.Username}} on stegodon - {{.Post.Message}}" />
        <meta name="keywords" content="fediverse, activitypub, ssh, blog, terminal, mastodon, federated, decentralized" />
        <meta name="author" content="@{{.User.Username}}" />
        <link rel="canonical" href="https://{{.Host}}/u/{{.User.Username}}/{{.Post.NoteId}}" />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="article" />
        <meta property="og:url" content="https://{{.Host}}/u/{{.User.Username}}/{{.Post.NoteId}}" />
        <meta property="og:title" content="{{.Title}} - stegodon" />
        <meta property="og:description" content="{{.Post.Message}}" />
        <meta property="og:site_name" content="stegodon" />

        <!-- Twitter Card -->
        <meta name="twitter:card" content="summary" />
        <meta name="twitter:url" content="https://{{.Host}}/u/{{.User.Username}}/{{.Post.NoteId}}" />
        <meta name="twitter:title" content="{{.Title}}" />
        <meta name="twitter:description" content="{{.Post.Message}}" />

        <!-- Favicon -->
        <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><text x='50' y='70' text-anchor='middle' font-family='monospace' font-size='70' font-weight='bold' fill='%2300ff7f'>S</text></svg>">
        <link rel="stylesheet" href="/static/style.css">
    </head>
    <body>
        <div class="layout">
            <div class="sidebar minimized">
                <div class="sidebar-header">
                    <h1><a href="/"><span class="emoji">ü¶£</span> stegodon</a></h1>
                    <span class="version">v{{.Version}}</span>
                    <span class="toggle-btn"><span></span><span></span><span></span></span>
                </div>

                {{range .InfoBoxes}}
                <div class="info-box">
                    <h3>{{.TitleHTML}}</h3>
                    <div class="info-box-content">
                        {{.ContentHTML}}
                    </div>
                </div>
                {{end}}
            </div>

            <div class="sidebar-backdrop"></div>

            <div class="main-content">
                <div class="content-wrapper">
                    <div class="profile-header">
                        <h2>@{{.User.Username}}</h2>
                        <a href="/u/{{.User.Username}}" class="back-link">‚Üê @{{.User.Username}}'s timeline</a>
                    </div>

                    {{if .ServerMessage}}
                    <div class="server-message">
                        <strong>üì¢ Server Message:</strong> {{.ServerMessage.MessageHTML}}
                    </div>
                    {{end}}

                    {{if .ParentPost}}
                    <div class="thread-context">
                        <div class="reply-indicator">In reply to:</div>
                        <div class="post parent-post">
                            <div class="post-meta">
                                <a href="/u/{{.ParentPost.Username}}" class="post-author">@{{.ParentPost.Username}}</a>
                                <a href="/u/{{.ParentPost.Username}}/{{.ParentPost.NoteId}}" class="post-permalink">#</a>
                            </div>
                            <div class="post-content">
                                <p class="post-time">{{.ParentPost.TimeAgo}}</p>
                                <p class="post-text">{{.ParentPost.MessageHTML}}</p>
                            </div>
                            {{if or (gt .ParentPost.ReplyCount 0) (gt .ParentPost.LikeCount 0) (gt .ParentPost.BoostCount 0)}}
                            <div class="post-footer">
                                {{if gt .ParentPost.LikeCount 0}}
                                    <span class="like-count engagement-trigger" data-type="likes" data-note-id="{{.ParentPost.NoteId}}" style="cursor: pointer;">
                                        <span class="icon">‚≠ê</span> {{.ParentPost.LikeCount}}
                                    </span>
                                {{end}}
                                {{if gt .ParentPost.BoostCount 0}}
                                    <span class="boost-count engagement-trigger" data-type="boosts" data-note-id="{{.ParentPost.NoteId}}" style="cursor: pointer;">
                                        <span class="icon">üîÅ</span> {{.ParentPost.BoostCount}}
                                    </span>
                                {{end}}
                                {{if gt .ParentPost.ReplyCount 0}}<a href="/u/{{.ParentPost.Username}}/{{.ParentPost.NoteId}}" class="reply-count"><span class="icon">üí¨</span> {{.ParentPost.ReplyCount}}</a>{{end}}
                            </div>
                            {{end}}
                        </div>
                    </div>
                    {{end}}

                    <div class="post main-post">
                        <div class="post-meta">
                            <span class="post-caption">{{.Post.TimeAgo}}</span>
                        </div>
                        <div class="post-content">
                            <p class="post-text">{{.Post.MessageHTML}}</p>
                        </div>
                        {{if or (gt .Post.LikeCount 0) (gt .Post.BoostCount 0)}}
                        <div class="post-footer">
                            {{if gt .Post.LikeCount 0}}
                                <span class="like-count engagement-trigger" data-type="likes" style="cursor: pointer;">
                                    <span class="icon">‚≠ê</span> {{.Post.LikeCount}}
                                </span>
                            {{end}}
                            {{if gt .Post.BoostCount 0}}
                                <span class="boost-count engagement-trigger" data-type="boosts" style="cursor: pointer;">
                                    <span class="icon">üîÅ</span> {{.Post.BoostCount}}
                                </span>
                            {{end}}
                        </div>
                        {{end}}
                    </div>

                    {{if .Replies}}
                    <div class="replies-section">
                        <h3 class="replies-header">Replies ({{len .Replies}})</h3>
                        {{range .Replies}}
                        <div class="post reply-post{{if .IsRemote}} remote-reply{{end}}">
                            <div class="post-meta">
                                {{if .IsRemote}}
                                <a href="{{.ProfileURL}}" class="post-author remote-author" target="_blank" rel="noopener">@{{.Username}}@{{.UserDomain}} üåê</a>
                                {{if .PostURL}}<a href="{{.PostURL}}" class="post-permalink" target="_blank" rel="noopener" title="View on {{.UserDomain}}">#</a>{{end}}
                                {{else}}
                                <a href="/u/{{.Username}}" class="post-author">@{{.Username}}</a>
                                <a href="/u/{{.Username}}/{{.NoteId}}" class="post-permalink">#</a>
                                {{end}}
                            </div>
                            <div class="post-content">
                                <p class="post-time">{{.TimeAgo}}</p>
                                <p class="post-text">{{.MessageHTML}}</p>
                            </div>
                            {{if or (gt .ReplyCount 0) (gt .LikeCount 0) (gt .BoostCount 0)}}
                            <div class="post-footer">
                                {{if gt .LikeCount 0}}
                                    <span class="like-count engagement-trigger" data-type="likes" data-note-id="{{.NoteId}}" style="cursor: pointer;">
                                        <span class="icon">‚≠ê</span> {{.LikeCount}}
                                    </span>
                                {{end}}
                                {{if gt .BoostCount 0}}
                                    <span class="boost-count engagement-trigger" data-type="boosts" data-note-id="{{.NoteId}}" style="cursor: pointer;">
                                        <span class="icon">üîÅ</span> {{.BoostCount}}
                                    </span>
                                {{end}}
                                {{if gt .ReplyCount 0}}
                                    {{if .IsRemote}}
                                    {{if .PostURL}}<a href="{{.PostURL}}" class="reply-count" target="_blank" rel="noopener"><span class="icon">üí¨</span> {{.ReplyCount}}</a>{{end}}
                                    {{else}}
                                    <a href="/u/{{.Username}}/{{.NoteId}}" class="reply-count"><span class="icon">üí¨</span> {{.ReplyCount}}</a>
                                    {{end}}
                                {{end}}
                            </div>
                            {{end}}
                        </div>
                        {{end}}
                    </div>
                    {{end}}
                </div>
            </div>
        </div>

        <!-- Engagement Modal -->
        <div id="engagement-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="modal-close">&times;</span>
                <h3 id="modal-title"></h3>
                <div id="modal-body"></div>
            </div>
        </div>

        <script>
            // Engagement data
            const engagementData = {
                likers: [{{if .Post.Likers}}{{range $index, $user := .Post.Likers}}{{if $index}}, {{end}}"{{$user}}"{{end}}{{end}}],
                boosters: [{{if .Post.Boosters}}{{range $index, $user := .Post.Boosters}}{{if $index}}, {{end}}"{{$user}}"{{end}}{{end}}]
            };

            // Mobile toggle handler
            const sidebar = document.querySelector(".sidebar");
            const toggleBtn = document.querySelector(".toggle-btn");
            const backdrop = document.querySelector(".sidebar-backdrop");

            if (toggleBtn) {
                // Toggle sidebar on button click
                toggleBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    sidebar.classList.toggle("minimized");
                    const isOpen = !sidebar.classList.contains("minimized");
                    if (backdrop) {
                        backdrop.classList.toggle("active", isOpen);
                    }
                    document.body.classList.toggle("menu-open", isOpen);
                });

                // Close sidebar when clicking backdrop
                if (backdrop) {
                    backdrop.addEventListener("click", () => {
                        sidebar.classList.add("minimized");
                        backdrop.classList.remove("active");
                        document.body.classList.remove("menu-open");
                    });
                }
            }

            // Engagement modal handler
            const modal = document.getElementById("engagement-modal");
            const modalClose = document.querySelector(".modal-close");
            const modalTitle = document.getElementById("modal-title");
            const modalBody = document.getElementById("modal-body");

            // Add click handlers to engagement triggers
            document.querySelectorAll(".engagement-trigger").forEach(trigger => {
                trigger.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const type = trigger.dataset.type;
                    const noteId = trigger.dataset.noteId;
                    
                    // If this trigger has a note ID, fetch data via API (parent/reply posts)
                    // Otherwise use embedded data (main post)
                    if (noteId) {
                        await showEngagementFromAPI(type === "likes" ? "Liked by" : "Boosted by", noteId, type);
                    } else {
                        if (type === "likes") {
                            showEngagement("Liked by", engagementData.likers);
                        } else if (type === "boosts") {
                            showEngagement("Boosted by", engagementData.boosters);
                        }
                    }
                });
            });

            async function showEngagementFromAPI(title, noteId, type) {
                modalTitle.textContent = title;
                modalBody.innerHTML = "Loading...";
                modal.style.display = "flex";
                
                try {
                    const response = await fetch(`/api/engagement/${noteId}/${type}`);
                    const data = await response.json();
                    
                    if (data.users && data.users.length > 0) {
                        const userList = data.users.map(user => {
                            let displayName, userUrl;
                            
                            // Check if this is a remote user (contains @domain)
                            const parts = user.split("@").filter(p => p);
                            if (parts.length === 2) {
                                // Remote user: username@domain
                                displayName = `@${user}`;
                                userUrl = `https://${parts[1]}/@${parts[0]}`;
                            } else {
                                // Local user
                                displayName = `@${user}`;
                                userUrl = `/u/${user}`;
                            }
                            
                            return `<div class="engagement-user"><a href="${userUrl}" class="user-link" target="_blank" rel="noopener noreferrer">${displayName}</a></div>`;
                        }).join("");
                        modalBody.innerHTML = userList;
                    } else {
                        modalBody.innerHTML = "<p>No engagement information available yet.</p>";
                    }
                } catch (error) {
                    modalBody.innerHTML = "<p>Error loading engagement information.</p>";
                    console.error("Error fetching engagement:", error);
                }
            }

            function showEngagement(title, users) {
                modalTitle.textContent = title;
                
                if (users && users.length > 0) {
                    const userList = users.map(user => {
                        let displayName, userUrl;
                        
                        // Check if this is a remote user (contains @domain)
                        const parts = user.split("@").filter(p => p); // Remove empty strings
                        if (parts.length === 2) {
                            // Remote user: username@domain
                            displayName = `@${user}`;
                            userUrl = `https://${parts[1]}/@${parts[0]}`;
                        } else {
                            // Local user
                            displayName = `@${user}`;
                            userUrl = `/u/${user}`;
                        }
                        
                        return `<div class="engagement-user"><a href="${userUrl}" class="user-link" target="_blank" rel="noopener noreferrer">${displayName}</a></div>`;
                    }).join("");
                    modalBody.innerHTML = userList;
                } else {
                    modalBody.innerHTML = "<p>No engagement information available yet.</p>";
                }
                
                modal.style.display = "flex";
            }

            // Close modal handlers
            modalClose.addEventListener("click", () => {
                modal.style.display = "none";
            });

            modal.addEventListener("click", (e) => {
                if (e.target === modal) {
                    modal.style.display = "none";
                }
            });

            // Close modal on escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape" && modal.style.display === "flex") {
                    modal.style.display = "none";
                }
            });
        </script>
    </body>
</html>
{{end}}
